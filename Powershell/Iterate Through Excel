$sfilePath = "source_directory"
$dfilePath = "destination_directory"
$fileName = "source_file"
$fileNameSel = "destination_file "
 
# Source & Destination File Names
$fileDate = Get-Date -Format "M.d.yy"
$file = $sfilePath + $fileName + $fileDate +".csv"
$desFile = $dfilePath + $fileNameSel + $fileDate +".csv"
 
if(!(Test-Path -Path $desFile))
{
    # Load filtered content from the source file
    $csv = Import-Csv $file | ForEach-Object    {
        $dt = $_.'Date and Time of Call'.Trim()
        if ($dt -ne '') {
        $_| Add-Member -MemberType NoteProperty -Name 'Call Date' -Value $dt.Substring(0,$dt.IndexOf(' ')) -PassThru
      }
    }
   
    # Selected Items Array
    $selRows = @()
 
    # Unique IDs
    $agents = $csv | Select "ID" -Unique
 
    # Unique Dates
    $dates = $csv | Select "Date" -Unique
   
    # Getting call records for every unique Agent
    foreach($i in $agents)
    {
        # To limit maximum 4 calls per Agent
        $limitFlag = 0       
        foreach($j in $dates)
        {
            $j.'Call Date'
            $agentRows  =  $csv | Where-Object {($_.'ID' -eq $i.'ID') -and ($_.'Contact Code' -eq 'contact_code') -and ($_.'Agent Talk Time' -ge '0:05:00') -and ($_.'Date' -eq $j.'Date') } | select -First 1
            if($agentRows)
            {
              $limitFlag++
            }
            # else{"hi"}           
            if($limitFlag -le 4) {
               $selRows = $selRows +$agentRows
            }
        }
    }
    # Writing selected calls data into the destination file
    $selRows | export-CSV -NoTypeInformation $desFile
}
