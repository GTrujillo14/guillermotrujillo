 with cte1 as (
  select 
    'test1' as name,
    la.loan_id,
    la.app_d,
    la.app_amnt,
    i.score ida_score,
    i.c_credit_fraud,
    a.fraud_status,
    ae.fraud_v_d fraud_d,
    ae.fraud_reason,
    l.fraud_issue_status,
    e.email,
    la.purpose loan_purpose,
    la.orig_income,
    c.cr_fico fico_score,
    ac.ext_institution bank_name,
    ac.brn routing_number,
    m.ip_type,
    m.mm_ip_asnum,
    m.mm_ip_org,
    m.mm_ip_city,
    m.mm_ip_region
  from table_name la
      inner join table_name ac on (la.aid = ac.aid) 
      left outer join (
        select id,u_status,(case when u_status = 8 then 'Fraud' else 'No Fraud' end)fraud_status
        from table_name
        where u_status = 8) a on (la.aid = a.id)  
      left outer join (
        select id,score,(case when score > 649 or score <= 0 or score is null then 'Fraud' else 'Credit' end)c_credit_fraud
        from table_name) i on (la.ida_id = i.id)
      left outer join (
            select aid,mm_ip_city,mm_ip_region,mm_ip_asnum,mm_ip_org,
                 (case when mm_ip_usertype = 0 then 'Business'
                       when mm_ip_usertype = 1 then 'Cafe'
                       when mm_ip_usertype = 2 then 'Cellular'
                       when mm_ip_usertype = 3 then 'College'
                       when mm_ip_usertype = 4 then 'ContentDeliveryNetwork'
                       when mm_ip_usertype = 5 then 'Government'
                       when mm_ip_usertype = 6 then 'Hosting'
                       when mm_ip_usertype = 7 then 'Library'
                       when mm_ip_usertype = 8 then 'Military'
                       when mm_ip_usertype = 9 then 'Residential'
                       when mm_ip_usertype = 10 then 'Router'
                       when mm_ip_usertype = 11 then 'School'
                       when mm_ip_usertype = 12 then 'SearchEngineSpider'
                       when mm_ip_usertype = 13 then 'Traveler'
                    else null end)ip_type
            from table_name)m on (la.aid = m.aid)         
      left outer join (
        select id,(case when start_d is not null then 'Issued' else 'Not-Issued' end) fraud_issue_status
        from table_name) l on (l.id = la.loan_id)  
      left outer join (
        select aid,fraud_v_d,(case when fraud_type= 0 then 'Repeat'
                       when fraud_type = 1 then 'ID'
                       when fraud_type = 2 then 'Family'
                   else 'NA' end) fraud_reason
        from table_name)ae on (la.aid = ae.aid)     
      left outer join table_name e on (la.aid = e.aid)
      left outer join table_name c on (la.cr_id = c.id)
    where ae.fraud_v_d >= '2016-01-01'
    and la.status in (6,9,10,11)
    and a.u_status = 8 
  )
    select *
    from cte1
;

  with cte2 as (
        select 
        'test2' as Name,
        t.id trans_id,
        t.loan_id inv_loan_id, 
        t.init_d init_d,
        t.schedule_d schedule_d,
        t.from_aid from_user,
        t.to_aid to_user,
        t.from_id,
        t.to_id,
        t.amount,
        t.sub_status,
        t.type trans_type       
    from table_name t
      where t.status = 20 
 )     

  select *
  from cte2
  ;  

  with cte3 as (
      select 
        'test3' as Name,
        q.queue_name queue_name,
        (case when qi.queue = 41 then l.id else f.loan_id end) loan_id,
        t.id trans_id,
        qi.create_d refer_datetime,
        (case when qi.status in (0) then 'AVAILABLE'
              when qi.status in (1) then 'ACQUIRED'
              when qi.status in (2) then 'IN PROGRESS'
              when qi.status in (3) then 'SUSPEND'
              when qi.status in (4) then 'COMPLETE'
              when qi.status in (5) then'INCOMPLETE'
              when qi.status in (6) then 'CANCELLED'
          else null end)status,
        a.name ref_name,
        a.email ref_email,
        t.to_id aml_actor,
        qw.worker_id fraud_agent,
        qi.create_d,
        qi.create_d refer_ts,
        qi.queue queue,
        f.referral_reason,
        f.suspect_name,
        f.suspect_rel,
        f.ref_status,
        f.comments      
      from table_name qi    
        inner join table_name q on (qi.queue = q.id)    
        left outer join (
              select id,create_d,suspect_name,suspect_rel,referred_by_id,status ref_status,comments,loan_id,
                (case when referral_reason = 0 then 'BSA_REFERRAL' 
                      when referral_reason = 1 then 'IMPERSONATION'
                      when referral_reason = 2 then 'EDD'
                      when referral_reason = 3 then 'ID_THEFT_VICTIM'
                      when referral_reason = 4 then 'SMALL_BUSINESS'
                      when referral_reason = 5 then 'SUSPICIOUS_BANK'
                      when referral_reason = 6 then 'HOSTING_IP'
                      when referral_reason = 7 then 'FRAUD_TAB_MATCHES'
                      when referral_reason = 8 then 'FORGED_DOCS'
                    else null end)referral_reason
        from table_name) f on (qi.reference_id = f.id)     
        left outer join table_name t on (qi.reference_id = t.id) 
        left outer join table_name a on (f.referred_by_id = a.id)     
        left outer join table_name qw on (qi.worker_ref = qw.id)    
        left outer join table_name ac on (qi.reference_id = ac.id)
        left outer join table_name l on (ac.aid = l.aid)
      where qi.queue in (30,31,32,40,41)
      and qi.create_d is not null
  )
    select *
    from cte3
    ;
